{% extends 'layout/base.html' %}
{% block title %}Dashboard | Tracc{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-sm-12 col-md-10 col-lg-8">
        <!-- Greeting -->
        <h2 id="greet" class="mb-5 text-center"></h2>

        <!-- Stats Cards -->
        <div class="row mb-5 d-flex">
            <!-- Current Weight -->
            <div class="col-6 col-md-3 mb-3">
                <div class="card text-center p-3 card-height">
                    <h5>Current Weight</h5>
                    <div class="d-flex justify-content-center align-items-center card-body-margin">
                        <p class="fs-3r">{{ profile.current_weight|default:"-" }}</p>
                        <span class="fs-1r unit-margin">kg</span>
                    </div>
                </div>
            </div>
            <!-- Target Weight -->
            <div class="col-6 col-md-3 mb-3">
                <div class="card text-center p-3 card-height">
                    <h5>Target Weight</h5>
                    <div class="d-flex justify-content-center align-items-center card-body-margin">
                        <p class="fs-3r">{{ profile.target_weight|default:"-" }}</p>
                        <span class="fs-1r unit-margin">kg</span>
                    </div>
                </div>
            </div>
            <!-- BMI -->
            <div class="col-6 col-md-3 mb-3">
                <div 
                    class="card text-center p-3 card-height {{ bmi_data.style }}"
                    data-bs-toggle="tooltip" data-bs-placement="top"
                    data-bs-custom-class="{{ bmi_data.style }}"
                    data-bs-title="{{ bmi_data.class }}"
                >
                    <h5>BMI</h5>
                    {% if bmi_data.value %}
                        <p class="fs-3r mb--2">{{ bmi_data.value }}</p>
                        <small class="fs-4">{{ bmi_data.class }}</small>
                    {% else %}
                        <p class="fs-2r text-muted">-</p>
                    {% endif %}
                </div>
            </div>
            <!-- Progress -->
            <div class="col-6 col-md-3 mb-3">
                <div class="card text-center p-3 card-height">
                    <h5>Progress</h5>
                    {% if progress %}
                        <div class="progress-circle mx-auto my-3">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="54" stroke="#eee" stroke-width="12" fill="none"/>
                                <circle 
                                    id="progressIndicator"
                                    cx="60" cy="60" r="54" 
                                    stroke="{% if progress >= 75 %}#28a745{% elif progress >= 50 %}#ffc107{% else %}#dc3545{% endif %}" 
                                    stroke-width="12" 
                                    fill="none"
                                    stroke-dasharray="339.292"
                                    stroke-dashoffset="339.292"
                                    stroke-linecap="round"
                                    transform="rotate(-90 60 60)"
                                    style="--final-offset: {{ progress_offset }}"
                                />
                                <text x="50%" y="50%" text-anchor="middle" dy="0.3em" font-size="24" style="fill: var(--text-color) !important;">{{ progress }}%</text>
                            </svg>
                        </div>
                        <input type="hidden" id="progress_offset" value="{{ progress_offset }}">
                    {% else %}
                        <p class="text-muted">No progress yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Clock in -->
        <div class="text-center mb-5">
            {% if clock_in_time %}
                <button class="btn btn-primary" disabled>
                    Clocked In at <span id="clock-in-time" data-utc="{{ clock_in_time }}"></span>
                </button>
                <p></p>
            {% else %}
                <form method="POST" action="{% url 'clock_in' %}">
                    {% csrf_token %}
                    <input type="hidden" name="check_in" value="true">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-alarm"></i> Clock In Today
                    </button>
                </form>
            {% endif %}
        </div>

        <!-- Weekly Summary! -->
        <!-- {% if summary and not summary.has_checked %}
        <div 
            class="summary-card mb-5 d-flex justify-content-between align-items-center"
            data-bs-toggle="modal" 
            data-bs-target="#summaryModal"
        >
            Your Weekly Summary is ready!
            <i class="bi bi-box-arrow-in-right"></i>
        </div>
        {% endif %} -->
            
        <!-- Weekly Summary Trigger Card -->
        {% if summary and not summary.has_checked %}
        <div 
            class="summary-card mb-4"
            data-bs-toggle="modal" 
            data-bs-target="#summaryModal"
        >
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h5 class="mb-1 fw-bold">Your Weekly Summary is Ready!</h5>
                    <small class="text-muted">Tap to view your progress</small>
                </div>
                <i class="bi bi-box-arrow-in-right fs-3r"></i>
            </div>
        </div>
        {% endif %}

        <!-- Recent Logs -->
        <h4 class="mb-3">Recent Weight Logs</h4>
        <ul class="list-group mb-4">
            {% for log in recent_logs %}
            <li class="list-group-item">
                <div>{{ log.date }} - {{ log.weight }} kg</div>
                {% if log.notes %}<div>{{ log.notes }}</div>{% endif %}
            </li>
            {% empty %}
            <li class="list-group-item">No logs yet. Add your first one!</li>
            {% endfor %}
        </ul>

    <!-- Charts -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card p-3 h-100">
                <h5 class="card-title">Progress Chart</h5>
                <canvas id="progressChart" style="width:100%; height:200px;"></canvas>
                {{ line_data|json_script:"line-data" }}
            </div>
        </div>
    </div>


    <!-- Weekly Summary Modal -->
    <div class="modal fade bg-blur" id="summaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-4 shadow-lg border-0">

                <!-- Header -->
                <div class="modal-header border-0 pb-0">
                    <div class="modal-title">
                        <h4 class="fw-bold">Your Week in Review</h4>
                        <p class="text-muted my-0">
                            {{ summary.week_start|date:"j M" }} - {{ summary.week_end|date:"j M" }}
                        </p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body">
                    <div id="page-1" class="d-block">
                        <div class="summ-graph">
                            <canvas id="summChart" height="350" width="500"></canvas>
                            {{ sum_line_data|json_script:"summ-line-data" }}
                        </div>
                        
                        <p class="mb-1">
                            <strong>Average Weight:</strong> {{ summary.avg_weight }} kg  
                            <span class="{% if summary.change_from_last_week > 0 %}text-danger{% else %}text-success{% endif %}">
                                ({{ summary.change_from_last_week }} kg from last week)
                            </span>
                        </p>
                        <p class="text-muted">
                            Your weight averaged at <strong>{{ summary.avg_weight }} kg</strong> last week,  
                            which was <strong>{{ summary.change_from_last_week }} kg</strong> 
                            {% if summary.change_from_last_week > 0 %} more than the {% elif summary.change_from_last_week < 0 %} less than the {% else %} same as {% endif %}
                            previous week.
                        </p>
                    </div>
                    <div id="page-2" class="d-none">
                        <div class="mb-4">
                            <h4 class="fw-bold">Highlights</h4>
                            <div class="row mt-4">
                                {% for key, value in summary.highlights.items %}
                                    <div class="col-6">
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h5 class="card-title hlts-title text-center">
                                                    {% if key == 'logs' %}
                                                    <!-- logged in -->
                                                    <i class="bi bi-check-square" style="color: #008000;"></i>
                                                    {% elif key == 'streak' %}
                                                    <!-- streaks -->
                                                    <i class="bi bi-fire" style="color: #aa4203;"></i>
                                                    {% elif key == 'gain' %}
                                                    <!-- weight gain -->
                                                    <i class="bi bi-caret-up-fill" style="color: #FF0000;"></i>
                                                    {% elif key == 'loss' %}
                                                    <!-- weight loss -->
                                                    <i class="bi bi-caret-down-fill" style="color: #008000;"></i>
                                                    {% endif %}
                                                </h5>
                                                <p class="card-text text-center">{{ value }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% empty %}
                                    <li>No highlights available</li>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="modal-footer border-0 pt-0 d-flex justify-content-between">
                    <button id="summ-btn-prev" type="button" class="btn btn-primary rounded-pill px-4 d-none float-left" onclick="changePage(-1)">
                        Previous
                    </button>
                    <button id="summ-btn-next" type="button" class="btn btn-primary rounded-pill px-4 d-block" onclick="changePage(1)">
                        Next
                    </button>
                    <button id="summ-btn-gta" type="button" class="btn btn-primary rounded-pill px-4 d-none" onclick="changePage(1)">
                        Go to Analytics
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Clock in time localization.
            const el = document.getElementById("clock-in-time");
            if (el) {
                const utcString = el.dataset.utc;
                if (utcString) {
                    const localDate = new Date(utcString);
                    if (!isNaN(localDate)) {
                        el.textContent = localDate.toLocaleString([], { 
                            hour: "2-digit", 
                            minute: "2-digit" 
                        });
                    }
                }
            }

            // Progress Circle Animation.
            const progressCircle = document.getElementById('progressIndicator');
            const offsetInput = document.getElementById('progress_offset');
            
            if (progressCircle && offsetInput) {
                const offset = parseFloat(offsetInput.value);
                // Trigger smooth animation
                progressCircle.setAttribute('stroke-dashoffset', offset);
            }

            // Greeting
            const h = new Date().getHours();
            let g = "Hello";
            let icon = '<i class="bi bi-stars"></i>';
            if (h < 12) g = "Good Morning";
            else if (h < 17) g = "Good Afternoon";
            else g = "Good Evening";

            document.getElementById("greet").innerHTML = `${g}, {{ request.user.first_name|default:request.user.username }}!`;

            // Line Graph.
            const progress_ctx = document.getElementById('progressChart').getContext('2d');
            const lineData = JSON.parse(document.getElementById('line-data').textContent);

            let weights = lineData.weights || [];
            let minWeight = Math.min(...weights);
            let maxWeight = Math.max(...weights);

            new Chart(progress_ctx, {
                type: 'line',
                data: {
                    labels: lineData.labels || [], 
                    datasets: [{
                        label: 'Weight',
                        data: weights,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Weight (kg)'
                            },
                            beginAtZero: false,
                            suggestedMin: minWeight - 2,
                            suggestedMax: maxWeight + 2
                        }
                    }
                }
            });

            // Line Graph.
            const summary_ctx = document.getElementById('summChart').getContext('2d');
            const summlineData = JSON.parse(document.getElementById('summ-line-data').textContent);

            weights = summlineData.weights || [];
            minWeight = Math.min(...weights);
            maxWeight = Math.max(...weights);

            new Chart(summary_ctx, {
                type: 'line',
                data: {
                    labels: summlineData.labels || [], 
                    datasets: [{
                        label: 'Weight',
                        data: weights,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            title: {
                                display: false,
                            },
                            ticks: {
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            title: {
                                display: false,
                            },
                            beginAtZero: false,
                            suggestedMin: minWeight - 2,
                            suggestedMax: maxWeight + 2
                        }
                    }
                }
            });
        });

        // Weekly Summary.
        let currPage = 1;
        let prevBtn = document.getElementById("summ-btn-prev");
        let nextBtn = document.getElementById("summ-btn-next");
        let gtaBtn = document.getElementById("summ-btn-gta");
        let page1Div = document.getElementById("page-1");
        let page2Div = document.getElementById("page-2");
        function changePage(incr) {
            currPage += incr;
            console.log(currPage)
            if (currPage === 1) {
                prevBtn.classList.remove("d-block");
                prevBtn.classList.add("d-none");
                gtaBtn.classList.remove("d-block");
                gtaBtn.classList.add("d-none");
                nextBtn.classList.remove("d-none");
                nextBtn.classList.add("d-block");

                page1Div.classList.remove("d-none");
                page1Div.classList.add("d-block");
                page2Div.classList.remove("d-block");
                page2Div.classList.add("d-none");
            } else if (currPage === 2) {
                prevBtn.classList.add("d-block");
                prevBtn.classList.remove("d-none");
                gtaBtn.classList.add("d-block");
                gtaBtn.classList.remove("d-none");
                nextBtn.classList.add("d-none");
                nextBtn.classList.remove("d-block");
                
                page1Div.classList.add("d-none");
                page1Div.classList.remove("d-block");
                page2Div.classList.add("d-block");
                page2Div.classList.remove("d-none");
            }
        }
    </script>
{% endblock %}